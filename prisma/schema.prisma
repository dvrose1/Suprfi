// SuprFi Prisma Schema
// This file defines the complete database structure for SuprFi MVP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// ============================================
// CORE ENTITIES
// ============================================

model Customer {
  id             String        @id @default(cuid())
  crmCustomerId  String?       @unique
  firstName      String
  lastName       String
  email          String
  phone          String
  addressLine1   String?
  addressLine2   String?
  city           String?
  state          String?
  postalCode     String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  jobs              Job[]
  applications      Application[]
  borrowerSessions  BorrowerSession[]
  borrowerMagicLinks BorrowerMagicLink[]
  
  @@index([email])
  @@index([phone])
  @@index([crmCustomerId])
}

model Job {
  id             String        @id @default(cuid())
  crmJobId       String?       @unique
  customerId     String
  customer       Customer      @relation(fields: [customerId], references: [id])
  estimateAmount Decimal       @db.Decimal(10,2)
  status         String        @default("pending")
  technicianId   String?
  serviceType    String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  applications   Application[]
  
  @@index([customerId])
  @@index([crmJobId])
  @@index([status])
}

// ============================================
// FINANCING WORKFLOW
// ============================================

model Application {
  id             String        @id @default(cuid())
  jobId          String
  job            Job           @relation(fields: [jobId], references: [id])
  customerId     String
  customer       Customer      @relation(fields: [customerId], references: [id])
  token          String        @unique
  tokenExpiresAt DateTime
  status         String        @default("initiated") // initiated, submitted, approved, declined, funded
  
  // Snapshot data from integrations (JSONB)
  plaidData      Json?
  personaData    Json?
  creditData     Json?
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  decision       Decision?
  loan           Loan?
  
  @@index([token])
  @@index([status])
  @@index([createdAt])
}

model Decision {
  id                String        @id @default(cuid())
  applicationId     String        @unique
  application       Application   @relation(fields: [applicationId], references: [id])
  
  score             Int?
  decisionStatus    String        // approved, pending, declined, manual_review
  decisionReason    String?
  ruleHits          Json?         // Array of rule IDs that triggered
  evaluatorVersion  String        @default("v1.0")
  decidedAt         DateTime      @default(now())
  decidedBy         String?       // "system" or user_id
  
  offers            Offer[]
  manualReview      ManualReview?
  
  @@index([decisionStatus])
  @@index([decidedAt])
}

model Offer {
  id               String        @id @default(cuid())
  decisionId       String
  decision         Decision      @relation(fields: [decisionId], references: [id])
  
  termMonths       Int
  apr              Decimal       @db.Decimal(5,2)
  monthlyPayment   Decimal       @db.Decimal(10,2)
  downPayment      Decimal       @db.Decimal(10,2) @default(0)
  originationFee   Decimal       @db.Decimal(10,2) @default(0)
  totalAmount      Decimal       @db.Decimal(10,2)
  
  lenderId         String?
  routingType      String        @default("AUTO") // AUTO, MANUAL
  
  selected         Boolean       @default(false)
  selectedAt       DateTime?
  
  createdAt        DateTime      @default(now())
  
  @@index([decisionId])
}

model Loan {
  id               String        @id @default(cuid())
  applicationId    String        @unique
  application      Application   @relation(fields: [applicationId], references: [id])
  
  lenderLoanId     String?
  lenderName       String?
  fundedAmount     Decimal       @db.Decimal(10,2)
  fundingDate      DateTime?
  
  paymentSchedule  Json?         // Array of {date, amount, status}
  
  status           String        @default("pending") // pending, funded, repaying, paid_off, defaulted
  
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  
  @@index([status])
  @@index([lenderLoanId])
}

// ============================================
// DECISIONING & MANUAL REVIEW
// ============================================

model ManualReview {
  id             String        @id @default(cuid())
  decisionId     String        @unique
  decision       Decision      @relation(fields: [decisionId], references: [id])
  
  reason         String        // "thin_file", "fraud_flag", "borderline_score"
  priority       Int           @default(1) // 1=high, 2=medium, 3=low
  assignedTo     String?       // user_id
  status         String        @default("pending") // pending, in_review, resolved
  
  notes          String?
  resolution     String?       // "approved", "declined", "approved_with_conditions"
  resolvedBy     String?
  resolvedAt     DateTime?
  
  createdAt      DateTime      @default(now())
  
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
}

model PricingRule {
  id                  String    @id @default(cuid())
  name                String
  description         String?
  
  // JSON predicate: {field: "credit_score", operator: ">=", value: 700}
  predicate           Json
  
  // JSON adjustments: {apr_adjustment: 2.0, max_term: 48}
  pricingAdjustments  Json
  
  priority            Int       @default(100)
  active              Boolean   @default(true)
  
  createdBy           String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@index([active])
  @@index([priority])
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id          String    @id @default(cuid())
  entityType  String    // "application", "decision", "loan", "user"
  entityId    String
  
  actor       String    // user_id or "system"
  action      String    // "created", "updated", "approved", "viewed_pii"
  
  // Snapshot of changes
  payload     Json?
  
  ipAddress   String?
  userAgent   String?
  
  timestamp   DateTime  @default(now())
  
  @@index([entityType, entityId])
  @@index([actor])
  @@index([timestamp])
}

// ============================================
// CRM SYNC
// ============================================

model CrmSyncLog {
  id              String    @id @default(cuid())
  crmType         String    @default("fieldroutes")
  direction       String    // "inbound" (CRM → SuprFi) or "outbound" (SuprFi → CRM)
  
  entityType      String    // "customer", "job", "financing_status"
  entityId        String
  crmEntityId     String?
  
  status          String    // "success", "failed", "retrying"
  errorMessage    String?
  
  requestPayload  Json?
  responsePayload Json?
  
  attemptCount    Int       @default(1)
  
  createdAt       DateTime  @default(now())
  
  @@index([status])
  @@index([crmType, entityType])
  @@index([createdAt])
}

// ============================================
// ADMIN AUTH
// ============================================

model AdminUser {
  id            String         @id @default(cuid())
  email         String         @unique
  passwordHash  String
  role          String         // god, admin, ops, viewer
  name          String?
  isActive      Boolean        @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?        // ID of admin who invited them
  
  sessions      AdminSession[]
  adminAuditLogs AdminAuditLog[]
  
  @@index([email])
  @@index([role])
  @@index([isActive])
}

model AdminSession {
  id           String    @id @default(cuid())
  userId       String
  user         AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String    @unique
  expiresAt    DateTime
  rememberMe   Boolean   @default(false)
  lastActiveAt DateTime  @default(now())
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime  @default(now())
  
  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model AdminAuditLog {
  id          String    @id @default(cuid())
  userId      String
  user        AdminUser @relation(fields: [userId], references: [id])
  action      String    // login, logout, user_created, user_updated, role_changed, etc.
  targetType  String?   // admin_user, application, contractor, etc.
  targetId    String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model PasswordReset {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  
  @@index([token])
  @@index([email])
}

// ============================================
// CONTRACTOR / SUPRCLIENT
// ============================================

model Contractor {
  id            String   @id @default(cuid())
  
  // Business info
  email         String   @unique
  businessName  String?
  name          String?
  phone         String?
  
  // Service details
  serviceType   String?  // "hvac", "plumbing", "electrical", "pest", "general"
  state         String?
  
  // Status
  status        String   @default("approved") // approved, active, suspended
  
  // SuprClient specific
  apiKey        String?  @unique  // For CRM integration
  settings      Json?    // Notification preferences, branding, etc.
  tier          String   @default("standard") // standard, premium, enterprise
  
  // Metadata
  source        String?  // Where they came from (waitlist, direct, etc.)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  users         ContractorUser[]
  jobs          ContractorJob[]
  
  @@index([email])
  @@index([status])
  @@index([apiKey])
}

model ContractorUser {
  id            String   @id @default(cuid())
  contractorId  String
  contractor    Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  email         String   @unique
  passwordHash  String
  name          String?
  phone         String?
  
  role          String   @default("tech") // owner, manager, tech, viewer
  isActive      Boolean  @default(true)
  lastLoginAt   DateTime?
  
  invitedBy     String?  // ContractorUser ID who invited them
  inviteToken   String?  @unique // For pending invitations
  inviteExpiresAt DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  sessions      ContractorSession[]
  auditLogs     ContractorAuditLog[]
  
  @@index([contractorId])
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([inviteToken])
}

model ContractorSession {
  id           String   @id @default(cuid())
  userId       String
  user         ContractorUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token        String   @unique
  expiresAt    DateTime
  rememberMe   Boolean  @default(false)
  lastActiveAt DateTime @default(now())
  ipAddress    String?
  userAgent    String?
  
  createdAt    DateTime @default(now())
  
  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model ContractorAuditLog {
  id          String   @id @default(cuid())
  userId      String
  user        ContractorUser @relation(fields: [userId], references: [id])
  
  action      String   // login, logout, sent_link, viewed_app, generated_qr, etc.
  targetType  String?  // application, loan, team_member, etc.
  targetId    String?
  
  metadata    Json?    // Additional context
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model ContractorPasswordReset {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  
  @@index([token])
  @@index([email])
}

// Link contractors to jobs they initiate
model ContractorJob {
  id            String   @id @default(cuid())
  contractorId  String
  contractor    Contractor @relation(fields: [contractorId], references: [id])
  
  jobId         String   @unique
  
  // Who initiated this financing request
  initiatedBy   String?  // ContractorUser ID
  initiatedAt   DateTime @default(now())
  
  // How it was sent
  sendMethod    String?  // "sms", "email", "qr"
  
  @@index([contractorId])
  @@index([jobId])
}

// ============================================
// BORROWER PORTAL
// ============================================

model BorrowerSession {
  id           String   @id @default(cuid())
  customerId   String
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  token        String   @unique
  expiresAt    DateTime
  lastActiveAt DateTime @default(now())
  ipAddress    String?
  userAgent    String?
  
  createdAt    DateTime @default(now())
  
  @@index([token])
  @@index([customerId])
  @@index([expiresAt])
}

model BorrowerMagicLink {
  id         String    @id @default(cuid())
  customerId String
  customer   Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  token      String    @unique
  expiresAt  DateTime
  usedAt     DateTime?
  
  createdAt  DateTime  @default(now())
  
  @@index([token])
  @@index([customerId])
}

// ============================================
// WAITLIST
// ============================================

model Waitlist {
  id              String    @id @default(cuid())
  
  // User type
  type            String    // "homeowner" or "contractor"
  
  // Common fields
  email           String
  name            String?
  phone           String?
  
  // Homeowner-specific
  zipCode         String?
  repairType      String?   // "hvac", "plumbing", "electrical", "other"
  
  // Contractor-specific
  businessName    String?
  serviceType     String?   // "hvac", "plumbing", "electrical", "general"
  state           String?
  
  // Metadata
  source          String?   // "home_page", "contractor_page", etc.
  referrer        String?
  utmParams       Json?
  
  // Status
  status          String    @default("active")  // "active", "converted", "unsubscribed"
  emailSent       Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([email])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}
